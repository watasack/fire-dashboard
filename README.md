# FIRE Dashboard — シミュレーション仕様書

## 実行方法

```bash
python scripts/generate_dashboard.py
# → dashboard/index.html に出力
```

---

## 月次シミュレーションの処理順序

各月の処理は以下の順序で行われる。

```
① 年変わりチェック
   → NISA年間投資額をリセット
   → prev_year_capital_gains = 今年の実現益（翌年の健康保険料計算に使用）

② 収入計算
   → 労働収入（修平・桜）、年金、児童手当を合算

③ 支出計算
   → 基本生活費、教育費、住宅ローン、メンテナンス、
      ワーケーション、社会保険料（FIRE後のみ）を合算

④ 収入を現金に加算
   cash += total_income

⑤ 支出を現金から差し引き
   cash >= expense → cash -= expense
   cash <  expense → 不足分を株式から売却（NISA→課税口座の順）

⑥ 株式の月次リターンを計上
   stocks += stocks × monthly_return_rate
   ※ 簿価は増えない（含み益）

⑦ FIRE後のみ: 最低現金残高（500万円）を維持
   cash < 500万 かつ stocks > 0 → 不足分を株式から売却して現金化

⑧ FIRE前のみ: 余剰現金を自動投資
   cash が (月次支出 × auto_invest_threshold) を超えた分を投資
   NISA枠優先 → 枠超過分は課税口座

⑨ FIREチェック（FIRE前のみ・2ヶ月目以降）
   「今退職した場合、90歳まで資産が持つか」を判定
   → 初めてTrueになった月 = FIRE達成日
```

---

## 収入の計算

### FIRE前の労働収入

```
修平の月収 = shuhei_income × (1 + income_growth_rate) ^ (経過年数)
桜の月収   = 通常時: sakura_income（固定・成長なし）
             産休育休期間中: maternity_leave.monthly_income（= 0円）
世帯月収   = 修平の月収 + 桜の月収
```

- `shuhei_income`: 465,875円/月（年収7,507,388円の社保・税引後）
- `sakura_income`: 300,000円/月（個人事業主の想定手取り・固定）
- `income_growth_rate`: 標準シナリオ 2%/年

### 産休・育休期間（桜のみ）

楓の誕生日（2027/04/15）を起点に判定。

```
leave_start = 楓の誕生日 - 2ヶ月
leave_end   = 楓の誕生日 + 12ヶ月

leave_start ≤ 当月 ≤ leave_end の間 → 桜の月収 = 0円
（個人事業主のため育休給付金なし）
```

### FIRE後・年金受給前（65歳まで）

```
修平の月収 = shuhei_post_fire_income = 50,000円（開発業務など）
桜の月収   = sakura_post_fire_income = 200,000円（個人事業主として継続）
労働収入合計 = 250,000円/月
```

### 年金受給開始後（65歳以降）

```
monthly_pension_income > 0 になった瞬間から労働収入 = 0円
（完全FIRE。年金のみで生活）
```

### 年金収入

受給開始年齢: 65歳

**修平（厚生年金 + 国民年金）**
```
厚生年金 = 平均標準報酬額 × 加入月数 × 0.005481
           = 625,615円 × 加入月数 × 0.005481
  加入月数 = (FIRE達成時の年齢 - 23歳) × 12

国民年金 = 816,000円 × (40年 / 40年) = 816,000円/年（満額）
  ※ 20〜60歳の40年間加入と仮定

合計 = 厚生年金 + 国民年金
```

平均標準報酬額の算出根拠: 年収7,507,388円（月固定556,000×12 + ボーナス417,694×2）÷ 12ヶ月 = 625,615円

**桜（国民年金のみ）**
```
国民年金 = 816,000円/年（満額）
  ※ 20〜60歳の40年間加入と仮定
```

### 児童手当（2024年10月改定後）

```
第1子・3歳未満            → 15,000円/月
第2子以降・3歳未満        → 20,000円/月
3歳以上・高校生以下（18歳未満） → 10,000円/月
```

子の誕生日から年齢を計算し、上記テーブルを参照して月次で加算。

---

## 支出の計算

### 基本生活費

**ライフステージの決定**

第1子（颯）の年齢で以下のテーブルを参照。

```
0〜5歳（未就学）  → young_child:  2,800,000円/年
6〜11歳（小学生） → elementary:   3,000,000円/年
12〜14歳（中学生）→ junior_high:  3,200,000円/年
15〜17歳（高校生）→ high_school:  3,300,000円/年
18〜21歳（大学生）→ university:   3,400,000円/年
22歳以降（独立後）→ empty_nest:   2,500,000円/年
```

家計調査2024年（二人以上世帯）から住居費・教育費を除き、車なし世帯の交通費差分（▲30万円/年）を反映した値。

**第2子以降の追加費用**

生まれていない子はスキップ。各子の誕生日から年齢を計算し、ステージ別の追加費用を加算。

```
0〜5歳   → +500,000円/年
6〜11歳  → +400,000円/年
12〜14歳 → +450,000円/年
15〜17歳 → +450,000円/年
18〜21歳 → +600,000円/年
22歳以降 → +0円
```

**インフレ適用**

基本生活費には `expense_growth_rate`（標準 2%/年）で複利インフレが乗る。

```
年次支出 = base_expense_by_stage × (1 + expense_growth_rate) ^ 経過年数
```

### 教育費

子供ごとの在籍段階を年齢から判定し、以下の費用を計上。
インフレ適用なし（文科省調査の固定値）。

**颯・楓の想定進学パス**

```
0〜2歳:  保育園（standard）  → 714,000円/年（実績ベース）
3〜5歳:  幼稚園（private）   → 200,000円/年（無償化適用後）
6〜11歳: 小学校（public）    → 320,000円/年
12〜14歳: 中学校（public）   → 490,000円/年
15〜17歳: 高校（public）     → 460,000円/年
18〜21歳: 大学（national）   → 540,000円/年
```

### 住宅ローン

```
月額 = 156,300円
2059年12月まで計上（以降は0円）
```

### 住宅メンテナンス

```
白アリ対策: 150,000円 / 10年周期（初回 2035年）
外壁補修:  4,000,000円 / 30年周期（初回 2055年）

実施年にのみ年額計上し、月次で均等割り（÷12）
```

### ワーケーション費用

```
楓（第2子）が 18歳以上の期間 → 700,000円/年
```

### 社会保険料（FIRE後のみ計上）

**国民年金保険料**
```
FIRE後かつ 60歳未満 → 16,980円/月（2024年度）
60歳以降 → 0円
```

**国民健康保険料（前年所得から動的計算）**

```
合計所得 = (shuhei_post_fire_income + sakura_post_fire_income) × 12
          + prev_year_capital_gains（前年の株式売却益）

所得割 = max(0, 合計所得 − 430,000) × 11.0%
固定部分 = 50,000円/人 × 2人 + 30,000円/世帯 = 130,000円

国民健康保険料 = min(所得割 + 固定部分, 1,060,000円)
```

- 基礎控除 430,000円（2024年度）
- 所得割率 11.0%（40歳以上・医療+支援金+介護分の全国平均）
- 上限 1,060,000円/年（2024年度）
- 年金受給後（65歳以降）は労働収入がゼロなので、実質「prev_year_capital_gains」のみが課税対象

---

## 資産運用の計算

### 月次リターン

```
monthly_return_rate = (1 + annual_return_rate) ^ (1/12) − 1

月末の株式残高 = 月初残高 × (1 + monthly_return_rate)
※ 簿価は変化しない（含み益は売却時に課税対象になる）
```

シナリオ別の `annual_return_rate`:

| シナリオ | 年率リターン | インフレ率 | 収入成長率 | 支出成長率 |
|---------|------------|---------|----------|----------|
| 楽観 | 7% | 1% | 3% | 1% |
| 標準 | 5% | 2% | 2% | 2% |
| 悲観 | 3% | 3% | 0% | 4% |

### モンテカルロシミュレーション

不確実性を考慮した確率的シミュレーション。

```
iterations            = 1000回（シミュレーション回数）
return_std_dev        = 0.06（年率リターンの標準偏差 6%）
mean_reversion_speed  = 0.3（平均回帰の速度、0.0-1.0）
show_distribution     = true（結果分布グラフを表示）

各回のシミュレーションで、年率リターンは正規分布に従ってランダムに変動:
  annual_return ~ N(期待リターン, 標準偏差^2)

→ 1000回の試行結果から、FIRE達成確率や資産残高の分布を推定
```

**標準偏差 6% の根拠:**
- 株式市場の長期リターンは平均回帰する傾向がある
- S&P500の年率リターン標準偏差（約18-20%）より低めに設定
- 長期投資（数十年）では短期的なボラティリティが平準化される

**平均回帰モデル（AR型）:**

大幅な値下がり後は反発しやすく、大幅な上昇後は調整が入りやすい。

```
mean_reversion_speed の意味:
  0.0 = 平均回帰なし（独立な乱数、連続暴落の可能性あり）
  0.3 = 緩やかな回帰（推奨、現実的な市場挙動）
  0.5 = 中程度の回帰
  1.0 = 完全回帰（非現実的、前月の逆方向に強く振れる）

例: 前月が -10% の大幅下落
  → mean_reversion_speed = 0.3 の場合
  → 次月の期待リターンは約 +3% バイアス（平均5% + 回帰調整）
  → 連続的な暴落シナリオを抑制し、リアルな市場を再現
```

**根拠:**
- 実際の株式市場は平均回帰する傾向（実証研究で確認）
- 大暴落後は急速に反発することが多い（リーマンショック、コロナショック等）
- 長期投資家にとってより現実的なシミュレーション

**拡張モデル（GARCH + 非対称多期間平均回帰）:**

より現実的な市場ダイナミクスをモデル化した上位版モデル（オプトイン）。

```yaml
enhanced_model:
  enabled: false  # デフォルトは無効、必要に応じて true に設定
```

**主な特徴:**
1. **ボラティリティ・クラスタリング（GARCH）**
   - 暴落後は高ボラティリティが持続する
   - 標準モデルでは常に一定のボラティリティを仮定

2. **非対称回復**
   - 暴落後の回復は遅い（5年程度、2008年型）
   - バブル崩壊後の収縮も遅い
   - 通常時は標準的な平均回帰

3. **レジーム持続性**
   - 弱気相場は一定期間持続する（現実的）
   - 標準モデルでは月ごとに独立

**いつ使うか:**
- FIRE計画で保守的な推定が必要な場合
- FIRE直後の順序リスク（sequence of returns risk）を評価したい場合
- より現実的な市場ダイナミクスを考慮したい場合

**トレードオフ:**
- ✅ より現実的なリスク評価（分布が約20-30%拡大）
- ✅ より保守的な推定（成功率が約2-3%低下）
- ⚠️ 平均リターンが若干上昇（約25%、長期では収束）

**注:** 標準モデル（mean_reversion_speed=0.3）でも十分に現実的です。
拡張モデルは、より詳細なリスク分析が必要な場合に使用してください。

**動的支出削減（暴落時の自動対応プロトコル）:**

暴落時に裁量的支出を自動削減し、副収入を増やすことで、資産破綻リスクを大幅に低減する機能（オプトイン）。

```yaml
dynamic_expense_reduction:
  enabled: false  # デフォルトは無効、必要に応じて true に設定
```

**主な特徴:**

1. **ドローダウン監視**
   - 過去12ヶ月のピーク資産からの下落率を月次で計算
   - 3段階の警戒レベルで自動判定

2. **3段階警戒システム**
   ```
   レベル0（正常）:   ドローダウン -10%未満     → 削減なし
   レベル1（警戒）:   ドローダウン -10%〜-20%  → 裁量的支出50%削減 + 月5万円副収入
   レベル2（深刻）:   ドローダウン -20%〜-35%  → 裁量的支出80%削減 + 月10万円副収入
   レベル3（危機）:   ドローダウン -35%以下     → 裁量的支出100%削減 + 月15万円副収入
   ```

3. **裁量的支出の自動分類**
   - 基本生活費を基礎生活費（75-60%）と裁量的支出（25-40%）に分類
   - ライフステージ別に裁量的支出比率を設定
   ```
   young_child（未就学）: 25%が裁量的
   elementary（小学生）:  30%が裁量的
   empty_nest（独立後）:  40%が裁量的（旅行・趣味等）
   ```

4. **副収入増加**
   - 暴落時に副業収入を段階的に増加
   - レベル1: 月5万円（週末副業等）
   - レベル2: 月10万円（本格副業）
   - レベル3: 月15万円（最大限の副業）

**効果（モンテカルロ1000回シミュレーション）:**

| 指標 | 削減なし | 削減あり | 改善 |
|------|---------|---------|------|
| FIRE成功率 | 53.4% | 99.8% | **+46.4ポイント** |
| 破産率 | 16.0% | 0.2% | **▲15.8ポイント** |
| P10（下位10%） | 0円（破産） | 336,000円 | 破産回避 |

**いつ使うか:**
- FIRE計画で暴落対応を含めたい場合
- 破産リスクを大幅に低減したい場合
- 暴落時の行動プランを事前にシミュレートしたい場合

**トレードオフ:**
- ✅ 破産リスクを大幅低減（16% → 0.2%）
- ✅ 成功率を大幅向上（53% → 99.8%）
- ⚠️ 暴落時の生活水準低下を許容（裁量的支出を削減）
- ⚠️ 暴落時の副業負担を許容（月15万円まで）

**注:** この機能を有効化すると、暴落時に自動的に支出を削減し、副収入を増やす前提でシミュレーションされます。
実際の行動可能性を考慮して、有効化を判断してください。

### 自動投資ロジック（FIRE前のみ）

```
required_cash = 月次支出 × cash_buffer_months（6ヶ月）
threshold     = max(required_cash × auto_invest_threshold（1.5倍）, min_cash_balance（500万円）)

cash > threshold → 投資可能額 = cash − required_cash を投資

① NISA残枠あり（nisa_annual_limit（360万円/年） − 今年の累計投資額 > 0）
   → 投資可能額と残枠の小さい方をNISAに投資
     nisa_balance    += 投資額
     nisa_cost_basis += 投資額（簿価 = 投資額）

② NISA枠超過分（invest_beyond_nisa = true の場合）
   → 課税口座に投資
     stocks            += 投資額
     stocks_cost_basis += 投資額
```

### 株式売却ロジック

不足資金が発生した際の売却順序:

```
① NISA口座から優先売却（非課税）
   nisa_sold    = min(不足額, nisa_balance)
   nisa_balance -= nisa_sold
   nisa_cost_basis は按分で減少

② 課税口座から補填
   taxable_stocks = stocks − nisa_balance
   平均取得単価  = (stocks_cost_basis − nisa_cost_basis) / taxable_stocks

   売却額（税前）を算出し、取得単価に基づく譲渡益を計算:
   譲渡益            = 売却額 × (1 − 平均取得単価/株価)
   税額              = 譲渡益 × 20.315%
   手取り額（税後）  = 売却額 − 税額

   capital_gains_this_year += 譲渡益
   （翌年の健康保険料計算に使用）
```

---

## FIRE判定ロジック

### 毎月のFIREチェック

処理⑨（月次ループ内）で以下を実行する。

```python
# FIRE後の支出で再計算（社会保険料を含む）
current_annual_expense = (
    基本生活費 + 教育費 + 住宅ローン + メンテナンス + ワーケーション
) × 12 + FIRE後の国民年金保険料 + FIRE後の国民健康保険料

# FIRE時に必要な現金バッファ
fire_cash_buffer = max(月次支出 × 6ヶ月, 500万円)
potential_investment = max(0, cash − fire_cash_buffer)

# 退職シミュレーション実行
result = simulate_post_fire_assets(
    現在の現金, 現在の株式, ...
    90歳まで資産が持つか？
)
→ 結果が True → fire_achieved = True（FIRE達成）
```

### FIRE後の資産シミュレーション（`simulate_post_fire_assets`）

`can_retire_now` から呼び出され、退職後の資産推移を月次で計算する。
ループ内の処理は本シミュレーションと同様（収入・支出・リターン・売却）。

```
月初資産 → 支出（副収入 + 年金 + 児童手当で相殺） → 株式リターン
→ 資産が 500万円（破綻ライン）を下回ったら破綻 → return 0
→ 90歳到達まで資産が持ったら → final_assets を返す（> 500万 で合格）
```

### FIRE目標額の計算

FIRE達成月を起点に、3シナリオ × 複数の仮想初期資産で `can_retire_now` を実行し、
**「すべてのシナリオで破綻しない最小資産」に安全バッファ 20% を乗じた値**を推奨目標額とする。

---

## 子供情報

| 名前 | 誕生日 |
|------|--------|
| 颯（第1子） | 2022/02/26 |
| 楓（第2子） | 2027/04/15（予定） |

---

## 定数一覧

| 定数名 | 値 | 意味 |
|--------|----|------|
| `_NATIONAL_PENSION_FULL_AMOUNT` | 816,000円 | 国民年金満額（2024年度） |
| `_EMPLOYEE_PENSION_MULTIPLIER` | 0.005481 | 厚生年金給付乗率（2003年4月以降） |
| `_PENSION_MAX_CONTRIBUTION_YEARS` | 40年 | 国民年金最大加入年数 |
| `_BANKRUPTCY_THRESHOLD` | 5,000,000円 | 破綻ライン |
| `_HEALTH_INS_BASIC_DEDUCTION` | 430,000円 | 健康保険料 基礎控除（2024年度） |
| `_HEALTH_INS_DEFAULT_INCOME_RATE` | 0.11 | 健康保険料 所得割率（40歳以上全国平均） |

---

## 開発者向け情報

開発者向けガイド（テスト実行方法、トラブルシューティング等）は [DEVELOPMENT.md](DEVELOPMENT.md) を参照してください。
